<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Semaphore</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Overview</a></li><li class="chapter-item expanded "><a href="../introduction/index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../exception_handling/index.html"><strong aria-hidden="true">2.</strong> Exception Handling</a></li><li class="chapter-item expanded "><a href="../memory_management/index.html"><strong aria-hidden="true">3.</strong> Memory Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../memory_management/contiguous_memory_allocation.html"><strong aria-hidden="true">3.1.</strong> Contiguous Memory Allocation</a></li><li class="chapter-item expanded "><a href="../memory_management/noncontiguous_memory_allocation.html"><strong aria-hidden="true">3.2.</strong> Non-contiguous Memory Allocation</a></li></ol></li><li class="chapter-item expanded "><a href="../virtual_memory/index.html"><strong aria-hidden="true">4.</strong> Virtual Memory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../virtual_memory/preliminary_concepts.html"><strong aria-hidden="true">4.1.</strong> Preliminary Concepts</a></li><li class="chapter-item expanded "><a href="../virtual_memory/local_replacement.html"><strong aria-hidden="true">4.2.</strong> Local Replacement</a></li><li class="chapter-item expanded "><a href="../virtual_memory/global_replacement.html"><strong aria-hidden="true">4.3.</strong> Global Replacement</a></li></ol></li><li class="chapter-item expanded "><a href="../processes_and_threads/index.html"><strong aria-hidden="true">5.</strong> Processes and Threads</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../processes_and_threads/processes.html"><strong aria-hidden="true">5.1.</strong> Processes</a></li><li class="chapter-item expanded "><a href="../processes_and_threads/threads.html"><strong aria-hidden="true">5.2.</strong> Threads</a></li><li class="chapter-item expanded "><a href="../processes_and_threads/scheduling.html"><strong aria-hidden="true">5.3.</strong> Scheduling</a></li></ol></li><li class="chapter-item expanded "><a href="../concurrency/index.html"><strong aria-hidden="true">6.</strong> Concurrency</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concurrency/mutual_exclusion_and_synchronization.html"><strong aria-hidden="true">6.1.</strong> Mutual Exclusion and Synchronization</a></li><li class="chapter-item expanded "><a href="../concurrency/semaphore.html" class="active"><strong aria-hidden="true">6.2.</strong> Semaphore</a></li><li class="chapter-item expanded "><a href="../concurrency/deadlock_and_starvation.html"><strong aria-hidden="true">6.3.</strong> Deadlock and Starvation</a></li><li class="chapter-item expanded "><a href="../concurrency/interprocess_communication.html"><strong aria-hidden="true">6.4.</strong> Interprocess Communication</a></li></ol></li><li class="chapter-item expanded "><a href="../file_system/index.html"><strong aria-hidden="true">7.</strong> File System</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="semaphore"><a class="header" href="#semaphore">Semaphore</a></h1>
<h2 id="key-terms"><a class="header" href="#key-terms">Key Terms</a></h2>
<ul>
<li>
<p>Semaphore: An integer value used for signaling among processes. Only three operations may be
performed on a semaphore, all of which are <strong>atomic</strong>: <strong>initialize, decrement, and increment</strong>. The decrement operation may result in the blocking of a process, and the increment
operation may result in the unblocking of a process. Also known as a counting
semaphore or a general semaphore.</p>
</li>
<li>
<p>Binary semaphore: A semaphore that takes on only the <strong>values 0 and 1</strong>.</p>
</li>
<li>
<p>Mutex: Similar to a binary semaphore. A key difference between the two is that <strong>the process that locks the mutex (sets the value to 0) must be the one to unlock it (sets the value to 1)</strong>.</p>
</li>
<li>
<p>Condition variable: A data type that is used to block a process or thread until a particular condition is true.</p>
</li>
<li>
<p>Monitor: A programming language construct that <strong>encapsulates variables, access procedures, and
initialization code within an abstract data type</strong>. The monitor’s variable may only be accessed via its access procedures and <strong>only one process may be actively accessing the monitor at any one time</strong>. The access procedures are critical sections. A monitor may have a queue of processes that are waiting to access it.</p>
</li>
<li>
<p>Event flags: A memory word used as a synchronization mechanism. Application code may associate a different event with each bit in a flag. A thread can wait for either a single event or a combination of events by checking one or multiple bits in the corresponding flag. The thread is blocked until all of the required bits are set (AND) or until at least one of the bits is set (OR).</p>
</li>
<li>
<p>Mailboxes/messages: A means for two processes to exchange information and that may be used for synchronization.</p>
</li>
<li>
<p>Spinlocks: Mutual exclusion mechanism in which a process executes in an infinite loop waiting for the value of a lock variable to indicate availability.</p>
</li>
</ul>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>信号量是操作系统提供的一种协调共享资源访问的方法，由一个整形（sem）变量和两个原子操作组成。</p>
<ul>
<li>
<p>P()：减少</p>
<ul>
<li>sem -1</li>
<li>若 sem &lt;0，进入等待，否则继续</li>
</ul>
</li>
<li>
<p>V()：增加</p>
<ul>
<li>sem +1</li>
<li>若 sem <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mrel">≤</span></span></span></span> 0，则唤醒一个进程</li>
</ul>
</li>
<li>
<p>信号量是<strong>被保护</strong>的整数变量：初始化完成后，只能通过 P()，V() 进程修改且 PV 是原子操作。</p>
</li>
<li>
<p>P() 可能阻塞，V() 不会阻塞</p>
</li>
</ul>
<p>For signaling, special variables called semaphores are used.</p>
<ul>
<li>To transmit a signal via semaphore s, a process executes the primitive semSignal (s).</li>
<li>To receive a signal via semaphore s, a process executes the primitive semWait (s); if the corresponding signal has not yet been transmitted, the process is suspended until the transmission takes place.</li>
</ul>
<p>To achieve the desired effect, we can view the semaphore as a variable that has an integer value upon which only three operations are defined:</p>
<ol>
<li>A semaphore may be initialized to a nonnegative integer value.</li>
<li>The semWait operation decrements the semaphore value. If the value becomes negative, then the process executing the semWait is blocked. Otherwise, the process continues execution.</li>
<li>The semSignal operation increments the semaphore value. If the resulting value is less than or equal to zero, then a process blocked by a semWait operation, if any, is unblocked.</li>
</ol>
<pre><code class="language-c++">struct semaphore {
    int count;
    queueType queue;
};
void semWait(semaphore s) // P 操作
{
    s.count--;
    if (s.count &lt; 0) {
    /* place this process in s.queue */;
    /* block this process */;
    }
}
void semSignal(semaphore s) { // V 操作
    s.count++;
    if (s.count&lt;= 0) {
    /* remove a process P from s.queue */;
    /* place process P on ready list */;
    }
}
</code></pre>
<h2 id="categories"><a class="header" href="#categories">Categories</a></h2>
<ul>
<li>
<p>Binary Semaphore, may only take on the value 0 and 1.</p>
<ul>
<li>
<p>Three Operations:</p>
<ol>
<li>binary semaphore may be initialized to 0 or 1.</li>
<li>The <code>semWaitB</code> operations checks the semaphore value. If the value is zero, then the process executing the <code>semWaitB</code> is blocked.</li>
<li>The <code>semSignalB</code> operation checks to see if any processes are blocked on this semaphore (semaphore value equals 0). If so, then a process blocked by a <code>semWaitB</code> operation is unblocked. If no processes are blocked, then the value of the semaphore is set to one.</li>
</ol>
<pre><code class="language-c++">struct semaphore {
  int count;
  queueType queue;
};
void semWait(semaphore s){
  s.count--;
  if (s.count &lt; 0) {
    /*place this process in s.queue*/;
    /*block this process*/;
  }
}
void semSignal(semaphore s) {
  s.count++;
  if (s.count&lt;= 0) {
    /*remove a process P from s.queue*/;
    /*place process P on ready list*/;
  }
}
</code></pre>
</li>
</ul>
</li>
<li>
<p>The nonbinary semaphore is often referred to as either a counting semaphore or a general semaphore.</p>
</li>
</ul>
<h2 id="application"><a class="header" href="#application">Application</a></h2>
<h3 id="mutual-exclusion"><a class="header" href="#mutual-exclusion">Mutual Exclusion</a></h3>
<p>每个 Critical Section 设置一个信号量，初值为 1。</p>
<ul>
<li>Consider n processes, identified in the array P(i), all of which need access to the same resource. Each process has a critical section
used to access the resource.</li>
<li>In each process, a semWait (s) is executed just before its critical section.</li>
<li>If the value of s becomes negative, the process is blocked. If the value is 1, then it is decremented to 0 and the process immediately enters its critical section.</li>
</ul>
<pre><code class="language-c++">/* program mutualexclusion */
const int n = /* number of processes */;
semaphore s = 1;
void P(int i) {
  while (true) {
    semWait(s);
    /* critical section */;
    semSignal(s);
    /* remainder */;
  }
}
void main() {
  parbegin (P(1), P(2), . . . , P(n));
}
</code></pre>
<p>必须<strong>成对使用</strong> PV 操作。</p>
<h3 id="conditional-synchronization"><a class="header" href="#conditional-synchronization">Conditional Synchronization</a></h3>
<p>用信号量实现条件同步：每个条件同步设置一个信号量</p>
<pre><code class="language-c++">condition = new Semaphore(0);
// Thread A
...M...
condition -&gt; P();
.. N ..

// Thread B
.. X ..
condition -&gt; V();
.. Y ..
</code></pre>
<h3 id="the-producerconsumer-problem"><a class="header" href="#the-producerconsumer-problem">The Producer/Consumer Problem</a></h3>
<ul>
<li>There are one or more producers generating some type of data (records, characters) and placing these in a buffer.（一个或多个生产者在生成数据后放在一个缓冲区里）</li>
<li>There is a single consumer that is taking items out of the buffer one at a time.（单个消费者从缓冲区取出数据处理）</li>
<li>The system is to be constrained to prevent the overlap of buffer operations, that is only one agent (producer or consumer) may access the buffer at any one time.（系统限制同时访问）</li>
</ul>
<p>The problem is to make sure that the producer won’t try to add data into the buffer if it’s full, and that the consumer won’t try to remove data from an empty buffer.</p>
<pre><code class="language-c++">/* program producerconsumer */
semaphore n = 0, s = 1;
void producer() {
  while (true) {
    produce();
    semWait(s);
    append();
    semSignal(s);
    semSignal(n);
  }
}
void consumer() {
  while (true) {
    semWait(n);
    semWait(s);
    take();
    semSignal(s);
    consume();
  }
}
void main() {
  parbegin (producer, consumer);
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../concurrency/mutual_exclusion_and_synchronization.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../concurrency/deadlock_and_starvation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../concurrency/mutual_exclusion_and_synchronization.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../concurrency/deadlock_and_starvation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
